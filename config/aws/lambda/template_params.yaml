AWSTemplateFormatVersion: "2010-09-09"
Description: "info-and-image-staging

  SAM template for cloud functions related to DocumentCloud

  "
Globals:
  Function:
    Environment:
      Variables:
        ENVIRONMENT: aws
        SERVERLESS: True
        EXTRACT_IMAGE_BATCH: "{{resolve:ssm:staging-EXTRACT_IMAGE_BATCH:latest}}"
        OCR_BATCH: "{{resolve:ssm:staging-OCR_BATCH:latest}}"
        OCR_VERSION: "{{resolve:ssm:staging-OCR_VERSION:latest}}"
        REDIS_PROCESSING_URL: "{{resolve:ssm:staging-REDIS_PROCESSING_URL:latest}}"
        REDIS_PROCESSING_PASSWORD: "{{resolve:ssm:staging-REDIS_PROCESSING_PASSWORD:latest}}"
        API_CALLBACK: "{{resolve:ssm:staging-API_CALLBACK:latest}}"
        PROCESSING_TOKEN: "{{resolve:ssm:staging-PROCESSING_TOKEN:latest}}"
        DOCUMENT_BUCKET: "{{resolve:ssm:staging-DOCUMENT_BUCKET:latest}}"
        PDF_PROCESS_TOPIC: "{{resolve:ssm:staging-PDF_PROCESS_TOPIC:latest}}"
        PAGE_CACHE_TOPIC: "{{resolve:ssm:staging-PAGE_CACHE_TOPIC:latest}}"
        IMAGE_EXTRACT_TOPIC: "{{resolve:ssm:staging-IMAGE_EXTRACT_TOPIC:latest}}"
        OCR_TOPIC: "{{resolve:ssm:staging-OCR_TOPIC:latest}}"
        ASSEMBLE_TEXT_TOPIC: "{{resolve:ssm:staging-ASSEMBLE_TEXT_TOPIC:latest}}"
        REDACT_TOPIC: "{{resolve:ssm:staging-REDACT_TOPIC:latest}}"
        PDF_SIZE_LIMIT: "{{resolve:ssm:staging-PDF_SIZE_LIMIT:latest}}"
        BLOCK_SIZE: "{{resolve:ssm:staging-BLOCK_SIZE:latest}}"
        SENTRY_DSN: "{{resolve:ssm:staging-SENTRY_DSN:latest}}"
        AWS_ARN_PREFIX: "{{resolve:ssm:staging-AWS_ARN_PREFIX:latest}}"
    Timeout: "{{resolve:ssm:staging-TIMEOUT:latest}}"
    MemorySize: "{{resolve:ssm:staging-MEMORY_SIZE:latest}}"
    VpcConfig:
      SecurityGroupIds:
        - "{{resolve:ssm:staging-SECURITY_GROUP_IDS:latest}}"
      SubnetIds:
        - "{{resolve:ssm:staging-SUBNET_ID_1:latest}}"
        - "{{resolve:ssm:staging-SUBNET_ID_2:latest}}"
Transform: AWS::Serverless-2016-10-31
Resources:
  ProcessDocFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.process_doc
      CodeUri: ./awsbin/utils
      # Trigger function via HTTP
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-PROCESS_DOC_TIMEOUT:latest}}"
      Events:
        ProcessPdfApi:
          Type: Api
          Properties:
            Path: /process_doc
            Method: POST
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  GetProgressFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.get_progress
      CodeUri: ./awsbin/utils
      # Trigger function via HTTP
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-GET_PROGRESS_TIMEOUT:latest}}"
      Events:
        ProcessPdfApi:
          Type: Api
          Properties:
            Path: /get_progress
            Method: POST
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  ProcessPdfFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.process_pdf
      CodeUri: ./awsbin/info_and_image
      # Trigger function via SNS
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-PROCESS_PDF_TIMEOUT:latest}}"
      Events:
        ProcessPdfApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-PDF_PROCESS_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  ProcessPageCacheFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.process_page_cache
      CodeUri: ./awsbin/info_and_image
      # Trigger function via SNS
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-PAGE_CACHE_TIMEOUT:latest}}"
      Events:
        ProcessPdfApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-PAGE_CACHE_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  ExtractImageFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.extract_image
      CodeUri: ./awsbin/info_and_image
      # Trigger function via SNS
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-EXTRACT_IMAGE_TIMEOUT:latest}}"
      Events:
        ExtractImageApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-IMAGE_EXTRACT_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  RedactDocFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.redact_doc
      CodeUri: ./awsbin/info_and_image
      # Trigger function via SNS
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-REDACT_DOC_TIMEOUT:latest}}"
      Events:
        ExtractImageApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-REDACT_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  RunTesseractFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.run_tesseract
      CodeUri: ./awsbin/ocr
      Environment:
        Variables:
          LD_LIBRARY_PATH: /var/task/tesseract
          TIMEOUTS: "{{resolve:ssm:staging-OCR_TIMEOUT:latest}}"
      # Trigger function via SNS
      Events:
        OcrApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-OCR_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"

  AssembleTextFunction:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.7
      Handler: main.assemble_page_text
      CodeUri: ./awsbin/info_and_image
      # Trigger function via SNS
      Environment:
        Variables:
          TIMEOUTS: "{{resolve:ssm:staging-ASSEMBLE_TEXT_TIMEOUT:latest}}"
      Events:
        ExtractImageApi:
          Type: SNS
          Properties:
            Topic: "{{resolve:ssm:staging-ASSEMBLE_TEXT_TOPIC_INTERNAL:latest}}"
      Role: "{{resolve:ssm:staging-LAMBDA_ROLE:latest}}"
